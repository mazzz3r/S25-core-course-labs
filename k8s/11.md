# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### 1. Creating a Secret Using kubectl

```bash
kubectl create secret generic my-secret --from-literal=username=admin --from-literal=password=supersecret
```

### 2. Verifying and Decoding the Secret

```bash
# Get the secret
kubectl get secret my-secret -o yaml

# Output
apiVersion: v1
data:
  password: c3VwZXJzZWNyZXQ=
  username: YWRtaW4=
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T11:36:11Z"
  name: my-secret
  namespace: default
  resourceVersion: "3047"
  uid: 5b6f75f0-f6eb-40ef-949d-f83f94d793c3
type: Opaque
```

```bash
# Decode the secret values
kubectl get secret my-secret -o jsonpath='{.data.username}' | base64 --decode
# Output
admin

kubectl get secret my-secret -o jsonpath='{.data.password}' | base64 --decode
# Output
supersecret
```

### 3. Managing Secrets with Helm

After creating the secrets.yaml file and updating the deployment, here are the results:

```bash
# Get pods
kubectl get po

# Output
NAME                                     READY   STATUS    RESTARTS      AGE
python-app-5d57df446c-2hrnf              1/1     Running   2 (11d ago)   11d
python-app-5d57df446c-gnjvx              1/1     Running   2 (11d ago)   11d
python-app-5d57df446c-t7zph              1/1     Running   2 (11d ago)   11d
python-app-helm-chart-76b757dd75-2qvjj   1/1     Running   0             36s
python-app-release-696c67fc9b-btdwj      1/1     Running   1 (11d ago)   11d
python-app-release-696c67fc9b-k6496      1/1     Running   1 (11d ago)   11d
python-app-release-696c67fc9b-xn52n      1/1     Running   1 (11d ago)   11d
```


```bash
# Verify secret inside the pod
kubectl exec python-app-helm-chart-76b757dd75-2qvjj -- printenv | grep MY_PASS

# Output
MY_PASS=supersecret
```


## Task 2: Vault Secret Management System

### 1. Installing Vault Using Helm Chart

```bash
# Add the HashiCorp Helm repository
helm repo add hashicorp https://helm.releases.hashicorp.com

# Output
"hashicorp" has been added to your repositories

# Update all repositories
helm repo update

# Output
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈

# Install the vault Helm chart
helm install vault hashicorp/vault --set "server.dev.enabled=true"

# Output
NAME: vault
LAST DEPLOYED: Sun Mar  9 14:44:08 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!
```

### 2. Setting a Secret in Vault and Configuring Kubernetes Authentication

```bash
# Port forward to the Vault pod
kubectl port-forward vault-0 8200:8200

# Output
Forwarding from 127.0.0.1:8200 -> 8200
Forwarding from [::1]:8200 -> 8200

# In a new terminal
export VAULT_ADDR=http://localhost:8200
export VAULT_TOKEN=root

# Enable the kv-v2 secrets engine
vault secrets enable -path=secret kv-v2

# Output
Success! Enabled the kv-v2 secrets engine at: secret/

# Create a secret
vault kv put secret/database/config username="db-user" password="db-password"

# Output
======= Secret Path =======
secret/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T11:52:12.789911047Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

# Verify the secret
vault kv get secret/database/config

# Output
======= Secret Path =======
secret/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T11:52:12.789911047Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-password
username    db-user

# Enable Kubernetes authentication
vault auth enable kubernetes

# Output
Success! Enabled kubernetes auth method at: kubernetes/

# Configure Kubernetes authentication
vault write auth/kubernetes/config \
  kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
  token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
  kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
  issuer="https://kubernetes.default.svc.cluster.local"

# Output
Success! Data written to: auth/kubernetes/config

# Create a policy for your application
vault policy write demo - <<EOF
path "secret/data/database/config" {
  capabilities = ["read"]
}
EOF

# Output
Success! Uploaded policy: demo

# Create a Kubernetes authentication role
vault write auth/kubernetes/role/demo \
  bound_service_account_names=python-app-helm-chart \
  bound_service_account_namespaces=default \
  policies=demo \
  ttl=24h

# Output
Success! Data written to: auth/kubernetes/role/demo
```

### 3. Implementing Vault Secrets in Helm Chart

```bash
# Update Helm chart to enable Vault integration
helm upgrade --install python-app ./helm-chart --set vault.enabled=true

# Output
Release "python-app" has been upgraded. Happy Helming!
NAME: python-app
LAST DEPLOYED: Sun Mar  9 14:55:10 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
TEST SUITE: None

# Get the pod name
kubectl get pods

# Output
NAME                                     READY   STATUS    RESTARTS      AGE
python-app-5d57df446c-2hrnf              1/1     Running   2 (11d ago)   11d
python-app-5d57df446c-gnjvx              1/1     Running   2 (11d ago)   11d
python-app-5d57df446c-t7zph              1/1     Running   2 (11d ago)   11d
python-app-helm-chart-54f58f9674-7fgvw   2/2     Running   0             3m40s
python-app-release-696c67fc9b-btdwj      1/1     Running   1 (11d ago)   11d
python-app-release-696c67fc9b-k6496      1/1     Running   1 (11d ago)   11d
python-app-release-696c67fc9b-xn52n      1/1     Running   1 (11d ago)   11d
vault-0                                  1/1     Running   0             21m
vault-agent-injector-66f45b5fd5-5pmwf    1/1     Running   0             21m

# Check if the secrets are injected
kubectl exec -it python-app-helm-chart-54f58f9674-7fgvw -- cat /vault/secrets/config.txt

# Output
Defaulted container "helm-chart" out of: helm-chart, vault-agent, vault-agent-init (init)
db-user:db-password
```
